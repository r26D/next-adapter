var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.manifest=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _config=require("@expo/config");var _packageManager=require("@expo/package-manager");var _chalk=_interopRequireDefault(require("chalk"));var _fsExtra=_interopRequireDefault(require("fs-extra"));var _path=_interopRequireDefault(require("path"));var _resolveFrom=_interopRequireDefault(require("resolve-from"));var generatedTag="@generated: @r26d/next-adapter@"+require('@r26d/next-adapter/package.json').version;function createJSTag(){return"// "+generatedTag;}function createBashTag(){return"# "+generatedTag;}function copyFileAsync(from,to,force,tag){var contents;return _regenerator.default.async(function copyFileAsync$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.t0=!force;if(!_context.t0){_context.next=5;break;}_context.next=4;return _regenerator.default.awrap(_fsExtra.default.pathExists(to));case 4:_context.t0=_context.sent;case 5:if(!_context.t0){_context.next=7;break;}throw new Error("Cannot overwrite file at \""+to+"\" without the `force` option");case 7:_context.next=9;return _regenerator.default.awrap(_fsExtra.default.pathExists(from));case 9:if(!_context.sent){_context.next=24;break;}if(!tag){_context.next=20;break;}_context.next=13;return _regenerator.default.awrap(_fsExtra.default.readFile(from,'utf8'));case 13:contents=_context.sent;_context.next=16;return _regenerator.default.awrap(_fsExtra.default.ensureDir(_path.default.dirname(to)));case 16:_context.next=18;return _regenerator.default.awrap(_fsExtra.default.writeFile(to,tag+"\n"+contents));case 18:_context.next=22;break;case 20:_context.next=22;return _regenerator.default.awrap(_fsExtra.default.copy(from,to,{overwrite:true,recursive:true}));case 22:_context.next=25;break;case 24:throw new Error("Expected template file for "+from+" doesn't exist at path: "+to);case 25:case"end":return _context.stop();}}},null,null,null,Promise);}function projectHasLatestFileAsync(destinationPath,tag){var contents;return _regenerator.default.async(function projectHasLatestFileAsync$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return _regenerator.default.awrap(_fsExtra.default.pathExists(destinationPath));case 2:if(!_context2.sent){_context2.next=7;break;}_context2.next=5;return _regenerator.default.awrap(_fsExtra.default.readFile(destinationPath,'utf8'));case 5:contents=_context2.sent;return _context2.abrupt("return",contents.includes(tag));case 7:return _context2.abrupt("return",false);case 8:case"end":return _context2.stop();}}},null,null,null,Promise);}var packageRoot=_path.default.join(__dirname,'../../');function getDependencies(projectRoot){var dependencies=['react-native-web','next'].filter(function(dependency){return!_resolveFrom.default.silent(projectRoot,dependency);});var devDependencies=['@r26d/next-adapter','babel-preset-expo'].filter(function(dependency){return!_resolveFrom.default.silent(projectRoot,dependency);});return{dependencies:dependencies,devDependencies:devDependencies};}var manifest=[{name:'Install Next.js dependencies',type:'required',destinationPath:function destinationPath(projectRoot){return'';},description:'Ensure your project has all of the required dependencies',onEnabledAsync:function onEnabledAsync(_ref){return function _callee(){var projectRoot,_getDependencies,dependencies,devDependencies,all;return _regenerator.default.async(function _callee$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:projectRoot=_ref.projectRoot;_getDependencies=getDependencies(projectRoot),dependencies=_getDependencies.dependencies,devDependencies=_getDependencies.devDependencies;all=[].concat((0,_toConsumableArray2.default)(dependencies),(0,_toConsumableArray2.default)(devDependencies));return _context3.abrupt("return",!!all.length);case 4:case"end":return _context3.stop();}}},null,null,null,Promise);}();},onSelectAsync:function onSelectAsync(_ref2){return function _callee2(){var projectRoot,_getDependencies2,dependencies,devDependencies,all,packageManager;return _regenerator.default.async(function _callee2$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:projectRoot=_ref2.projectRoot;_getDependencies2=getDependencies(projectRoot),dependencies=_getDependencies2.dependencies,devDependencies=_getDependencies2.devDependencies;all=[].concat((0,_toConsumableArray2.default)(dependencies),(0,_toConsumableArray2.default)(devDependencies));if(all.length){_context4.next=8;break;}console.log(_chalk.default.magenta.dim("\u203A All of the required dependencies are installed already"));return _context4.abrupt("return");case 8:console.log(_chalk.default.magenta("\u203A Installing the missing dependencies: "+all.join(', ')));case 9:packageManager=(0,_packageManager.createForProject)(projectRoot);if(!dependencies.length){_context4.next=13;break;}_context4.next=13;return _regenerator.default.awrap(packageManager.addAsync.apply(packageManager,(0,_toConsumableArray2.default)(dependencies)));case 13:if(!devDependencies.length){_context4.next=16;break;}_context4.next=16;return _regenerator.default.awrap(packageManager.addDevAsync.apply(packageManager,(0,_toConsumableArray2.default)(devDependencies)));case 16:case"end":return _context4.stop();}}},null,null,null,Promise);}();}},{name:'pages/index.js',type:'required',destinationPath:function destinationPath(projectRoot){return _path.default.resolve(projectRoot,'./pages/index.js');},templatePath:_path.default.resolve(packageRoot,'template/pages/index.js'),description:'the first page for your Next.js project.',onEnabledAsync:function onEnabledAsync(_ref3){var _this=this;return function _callee3(){var projectRoot,destinationPath;return _regenerator.default.async(function _callee3$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:projectRoot=_ref3.projectRoot;destinationPath=_this.destinationPath(projectRoot);_context5.next=4;return _regenerator.default.awrap(projectHasLatestFileAsync(destinationPath,createJSTag()));case 4:return _context5.abrupt("return",!_context5.sent);case 5:case"end":return _context5.stop();}}},null,null,null,Promise);}();},onSelectAsync:function onSelectAsync(_ref4){var _this2=this;return function _callee4(){var projectRoot,force,destinationPath;return _regenerator.default.async(function _callee4$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:projectRoot=_ref4.projectRoot,force=_ref4.force;console.log(_chalk.default.magenta("\u203A Creating "+_this2.description));destinationPath=_this2.destinationPath(projectRoot);_context6.next=5;return _regenerator.default.awrap(copyFileAsync(_this2.templatePath,destinationPath,force,createJSTag()));case 5:case"end":return _context6.stop();}}},null,null,null,Promise);}();}},{name:'pages/_document.js',type:'required',destinationPath:function destinationPath(projectRoot){return _path.default.resolve(projectRoot,'./pages/_document.js');},templatePath:_path.default.resolve(packageRoot,'template/pages/_document.js'),description:'a custom Next.js Document that ensures CSS-in-JS styles are setup.',onEnabledAsync:function onEnabledAsync(_ref5){var _this3=this;return function _callee5(){var projectRoot,destinationPath;return _regenerator.default.async(function _callee5$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:projectRoot=_ref5.projectRoot;destinationPath=_this3.destinationPath(projectRoot);_context7.next=4;return _regenerator.default.awrap(projectHasLatestFileAsync(destinationPath,createJSTag()));case 4:return _context7.abrupt("return",!_context7.sent);case 5:case"end":return _context7.stop();}}},null,null,null,Promise);}();},onSelectAsync:function onSelectAsync(_ref6){var _this4=this;return function _callee6(){var projectRoot,force,destinationPath;return _regenerator.default.async(function _callee6$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:projectRoot=_ref6.projectRoot,force=_ref6.force;console.log(_chalk.default.magenta("\u203A Creating "+_this4.description));destinationPath=_this4.destinationPath(projectRoot);_context8.next=5;return _regenerator.default.awrap(copyFileAsync(_this4.templatePath,destinationPath,force,createJSTag()));case 5:case"end":return _context8.stop();}}},null,null,null,Promise);}();}},{name:'babel.config.js',type:'required',destinationPath:function destinationPath(projectRoot){return _path.default.resolve(projectRoot,'./babel.config.js');},templatePath:_path.default.resolve(packageRoot,'template/babel.config.js'),description:'a universal Babel preset for loading projects in iOS, Android, and Next.js.',onEnabledAsync:function onEnabledAsync(_ref7){var _this5=this;return function _callee7(){var projectRoot,destinationPath;return _regenerator.default.async(function _callee7$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:projectRoot=_ref7.projectRoot;destinationPath=_this5.destinationPath(projectRoot);_context9.next=4;return _regenerator.default.awrap(projectHasLatestFileAsync(destinationPath,createJSTag()));case 4:return _context9.abrupt("return",!_context9.sent);case 5:case"end":return _context9.stop();}}},null,null,null,Promise);}();},onSelectAsync:function onSelectAsync(_ref8){var _this6=this;return function _callee8(){var projectRoot,force,destinationPath;return _regenerator.default.async(function _callee8$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:projectRoot=_ref8.projectRoot,force=_ref8.force;console.log(_chalk.default.magenta("\u203A Creating "+_this6.description));destinationPath=_this6.destinationPath(projectRoot);_context10.next=5;return _regenerator.default.awrap(copyFileAsync(_this6.templatePath,destinationPath,force,createJSTag()));case 5:case"end":return _context10.stop();}}},null,null,null,Promise);}();}},{name:'next.config.js',type:'required',destinationPath:function destinationPath(projectRoot){return _path.default.resolve(projectRoot,'./next.config.js');},templatePath:_path.default.resolve(packageRoot,'template/next.config.js'),description:'the Next.js config with Expo support.',onEnabledAsync:function onEnabledAsync(_ref9){var _this7=this;return function _callee9(){var projectRoot,destinationPath;return _regenerator.default.async(function _callee9$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:projectRoot=_ref9.projectRoot;destinationPath=_this7.destinationPath(projectRoot);_context11.next=4;return _regenerator.default.awrap(projectHasLatestFileAsync(destinationPath,createJSTag()));case 4:return _context11.abrupt("return",!_context11.sent);case 5:case"end":return _context11.stop();}}},null,null,null,Promise);}();},onSelectAsync:function onSelectAsync(_ref10){var _this8=this;return function _callee10(){var projectRoot,force,destinationPath;return _regenerator.default.async(function _callee10$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:projectRoot=_ref10.projectRoot,force=_ref10.force;console.log(_chalk.default.magenta("\u203A Creating "+_this8.description));destinationPath=_this8.destinationPath(projectRoot);_context12.next=5;return _regenerator.default.awrap(copyFileAsync(_this8.templatePath,destinationPath,force,createJSTag()));case 5:case"end":return _context12.stop();}}},null,null,null,Promise);}();}},{name:'Add build script',type:'required',destinationPath:function destinationPath(projectRoot){return'';},description:'the build script required for deploying to now.',onEnabledAsync:function onEnabledAsync(_ref11){return function _callee11(){var projectRoot,force,pkg,hasNowBuildScript;return _regenerator.default.async(function _callee11$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:projectRoot=_ref11.projectRoot,force=_ref11.force;if(!force){_context13.next=3;break;}return _context13.abrupt("return",true);case 3:_context13.next=5;return _regenerator.default.awrap(readPackageJsonAsync(projectRoot));case 5:pkg=_context13.sent;hasNowBuildScript=pkg.scripts.build&&pkg.scripts.build.trim()==='next build';return _context13.abrupt("return",!hasNowBuildScript);case 8:case"end":return _context13.stop();}}},null,null,null,Promise);}();},onSelectAsync:function onSelectAsync(_ref12){return function _callee12(){var projectRoot,force,pkg;return _regenerator.default.async(function _callee12$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:projectRoot=_ref12.projectRoot,force=_ref12.force;_context14.next=3;return _regenerator.default.awrap(readPackageJsonAsync(projectRoot));case 3:pkg=_context14.sent;if(!(!force&&pkg.scripts.build)){_context14.next=7;break;}console.warn(_chalk.default.yellow("\u203A A build script already exists."));return _context14.abrupt("return");case 7:pkg.scripts.build='next build';console.log(_chalk.default.magenta("\u203A Adding a build script to your `"+_chalk.default.bold("package.json")+"` for deployment to now."));_context14.next=11;return _regenerator.default.awrap(_fsExtra.default.writeFile(_path.default.resolve(projectRoot,'package.json'),JSON.stringify(pkg,null,2)));case 11:case"end":return _context14.stop();}}},null,null,null,Promise);}();}},{name:'Update git ignore',type:'required',destinationPath:function destinationPath(projectRoot){return _path.default.resolve(projectRoot,'.gitignore');},templatePath:_path.default.resolve(packageRoot,'template/default-gitignore'),description:'Ensure Next.js and Expo generated folders are ignored in .gitignore',onEnabledAsync:function onEnabledAsync(_ref13){var _this9=this;return function _callee13(){var projectRoot,destinationPath,contents;return _regenerator.default.async(function _callee13$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:projectRoot=_ref13.projectRoot;destinationPath=_this9.destinationPath(projectRoot);_context15.next=4;return _regenerator.default.awrap(_fsExtra.default.pathExists(destinationPath));case 4:if(_context15.sent){_context15.next=6;break;}return _context15.abrupt("return",true);case 6:_context15.next=8;return _regenerator.default.awrap(_fsExtra.default.readFile(destinationPath,'utf8'));case 8:contents=_context15.sent;return _context15.abrupt("return",!contents.includes(createBashTag()));case 10:case"end":return _context15.stop();}}},null,null,null,Promise);}();},onSelectAsync:function onSelectAsync(_ref14){var _this10=this;return function _callee14(){var projectRoot,force,destinationPath,contents,ignore;return _regenerator.default.async(function _callee14$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:projectRoot=_ref14.projectRoot,force=_ref14.force;destinationPath=_this10.destinationPath(projectRoot);_context16.next=4;return _regenerator.default.awrap(_fsExtra.default.pathExists(destinationPath));case 4:if(_context16.sent){_context16.next=8;break;}console.log(_chalk.default.magenta("\u203A Creating a default .gitignore for a universal Expo project with Next.js support"));_context16.next=8;return _regenerator.default.awrap(copyFileAsync(_this10.templatePath,destinationPath,true,createBashTag()));case 8:_context16.next=10;return _regenerator.default.awrap(_fsExtra.default.readFile(destinationPath,'utf8'));case 10:contents=_context16.sent;if(!contents.includes(createBashTag())){_context16.next=14;break;}console.warn(_chalk.default.yellow('The .gitignore already appears to contain expo generated files'));return _context16.abrupt("return");case 14:console.log(_chalk.default.magenta("\u203A Adding the generated folders to your .gitignore"));ignore=['',createBashTag(),'/.expo/*','# Expo Web','/web-build/*','# Expo Native','*.jks','*.p8','*.p12','*.key','*.mobileprovision','*.orig.*','# Next.js','/.next/*','/out/','# Next.js production','/build/','# Next.js dependencies','/.pnp','.pnp.js','# @end @r26d/next-adapter',''];contents+=ignore.join('\n');_context16.next=19;return _regenerator.default.awrap(_fsExtra.default.writeFile(destinationPath,contents));case 19:case"end":return _context16.stop();}}},null,null,null,Promise);}();}}];exports.manifest=manifest;function readPackageJsonAsync(projectRoot){var pkg;return _regenerator.default.async(function readPackageJsonAsync$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:pkg=(0,_config.getPackageJson)(projectRoot);if(!pkg.scripts)pkg.scripts={};return _context17.abrupt("return",pkg);case 3:case"end":return _context17.stop();}}},null,null,null,Promise);}